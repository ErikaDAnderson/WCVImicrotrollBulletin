---
title: "WCVI Microtrolling Data Update"
output:
  pdf_document:
    toc: true
    toc_depth: 2
header-includes:
 \usepackage{float}
 \floatplacement{figure}{H}
 \floatplacement{table}{H}
 \usepackage{fancyhdr}
 \pagestyle{fancy}
 \fancyfoot[RO,RE]{Produced on `r format(Sys.Date(), "%b. %d, %Y")`}
---

## Purpose
The purpose of this data bulletin is to share preliminary data in season from mcirotrolling fishing events targetting juvenile Chinook and Coho Salmon in WCVI Sounds including Barkley, Claqyoquot, Nootka, and Quatsino. For more information on this project, please contact Jessy Bokvist at Jessy.Bokvist@dfo-mpo.gc.ca. This report was produced on `r format(Sys.Date(), "%b. %d, %Y")`.

```{r setup, include=FALSE}

library(tidyverse) # basic data manipulation
library(readxl) #read excel files easily
library(lubridate) # date times
library(kableExtra) # pretty tables
library(bcmaps) # bc basemaps
library(patchwork) # group plots together
library(ggpubr) # arrange plots another way
library(car) # stats
library(ggplot2) #temporal spread of fishing trips figure
library(cowplot) #figure arrangement
library(fuzzyjoin)
library(reprex)
library(SwimmeR)

# by default, do not show R code
knitr::opts_chunk$set(echo = FALSE)

```

```{r loadData}

# load data from all excel files in Data folder
site_orig <- list.files(path = "./Data/",
                        pattern = "*.xlsx", 
                        full.names = T) %>% 
  map_df(~read_excel(., sheet = "01 SITE")) 

sets_orig <- list.files(path = "./Data/",
                        pattern = "*.xlsx", 
                        full.names = T) %>% 
  map_df(~read_excel(., sheet = "02 FISHING SETS")) 

ocean_orig <- list.files(path = "./Data/",
                         pattern = "*.xlsx",
                         full.names = T) %>%
  map_df(~read_excel(., sheet = "03 OCEANOGRAPHIC DATA"))

fish_orig <- list.files(path = "./Data/",
                        pattern = "*.xlsx", 
                        full.names = T) %>% 
  map_df(~read_excel(., sheet = "04 FISH"))

stomach_orig <- list.files(path = "./Data/",
                           pattern = "*.xlsx",
                           full.names = T) %>%
  map_df(~read_excel(., sheet = "05 STOMACH CONTENTS"))

stomachLU_orig <- list.files(path = "./Data/",
                           pattern = "*.xlsx",
                           full.names = T) %>%
  map_df(~read_excel(., sheet = "Lookup lists"))

# tidy data
site <- site_orig %>%
    # remove extra rows generated from NAs
  filter(!is.na(date)) %>%
  # remove default date given by excel in background
  mutate(time = str_sub(time, -8, -1),
         datetime = ymd_hms(str_c(date, time, sep = " ")))

sets <- sets_orig %>%
  mutate(end_time = str_sub(end_time, -8, -1))

ocean <- ocean_orig %>%
  mutate(time = str_sub(time, -8, -1))

fish <- fish_orig

stomach <- stomach_orig

stomachLU <- stomachLU_orig

# variables for text
overallStartDate <- format(min(site$date, na.rm = TRUE), "%b. %d, %Y")
overallEndDate <- format(max(site$date, na.rm = TRUE), "%b. %d, %Y")
numDaysFished <- site %>% select(date, sound) %>% distinct() %>% nrow()
soundsSampled <- unique(site$sound) %>% str_to_title() %>% sort()
ckCaught <- fish %>% filter(toupper(species) == "CN") %>% nrow()
coCaught <- fish %>% filter(toupper(species) == "CO") %>% nrow()
randomSamples <- fish %>% filter(frozen_random_clinical == "random") %>% nrow()
clinicalSamples <- fish %>% filter(frozen_random_clinical == "clinical") %>% nrow()

```


## Data Collected

This section summarizes the data collected from `r overallStartDate` to `r overallEndDate`. There were `r numDaysFished` days fished in total within the following sounds: `r soundsSampled`. In total, there were `r ckCaught` chinook and `r coCaught` coho caught. In addition, there were `r randomSamples` random samples and `r clinicalSamples` clinical samples frozen for transport to the Pacific Biological Station.

```{r dataCollected}
#JB March 24 2021 added in number of days fished/sound/month

sumfish <- sets %>%
  full_join(., site, by = "site_id") %>%
  select(sound, site_id, fishingset_id, date) %>%
  full_join(., fish, by = "fishingset_id") %>%
  mutate(MONTH_DISPLAY = month(date, label = TRUE, abbr = TRUE),
         sound = str_to_title(sound)) %>%
  mutate(DAY_DISPLAY = day(date),
         sound = str_to_title(sound)) %>%
  group_by(MONTH_DISPLAY, sound) %>%
  summarize(DaysFished = n_distinct(DAY_DISPLAY),
            ckCatch = sum(species == "CN", na.rm = TRUE),
            coCatch = sum(species == "CO", na.rm = TRUE),
            numRandom = sum(frozen_random_clinical == "random", na.rm = TRUE),
            numClinical = sum(frozen_random_clinical == "clinical", na.rm = TRUE),
            .groups = "drop") %>%
  mutate(MONTH_ORDER = case_when(
    MONTH_DISPLAY == "Oct" ~ 1,
    MONTH_DISPLAY == "Nov" ~ 2,
    MONTH_DISPLAY == "Dec" ~ 3,
    MONTH_DISPLAY == "Jan" ~ 4,
    MONTH_DISPLAY == "Feb" ~ 5,
    MONTH_DISPLAY == "Mar" ~ 6,
  )) %>%
  arrange(MONTH_ORDER) %>%
  select(-MONTH_ORDER)

kableExtra::kable(sumfish,
                  col.names = c("Month", "Location", "Days Fished", "Chinook", "Coho", "Random", "Clinical"),
                  booktabs = TRUE,
                  caption = "Summary of Salmon Caught and Samples Collected") %>%
  kable_styling() %>%
  add_header_above(c(" " = 3, "Catch" = 2, "Samples" = 2))


#Temporal spread of fishing Events Figure broken down by stat week
#JB working on 

#fishing days, fishing times - categorize as AM vs. PM (stacked bar chart), want x-axis as month and each month 4 possible binned weeks
TemporalPlot <- sets %>%
  full_join(., site, by = "site_id") %>%
  select(sound, site_id, fishingset_id, date, start_time) %>%
  full_join(., fish, by = "fishingset_id") %>%
  mutate(MONTH_DISPLAY = month(date, label = TRUE, abbr = TRUE),
         sound = str_to_title(sound)) %>%
  mutate(DAY_DISPLAY = day(date),
         sound = str_to_title(sound)) %>%
  mutate(Year = lubridate::year(date),
         sound = str_to_title(sound)) %>%
  mutate(DOY = lubridate::yday(date),
         sound = str_to_title(sound)) %>%
mutate(DayTime = lubridate::hour(start_time),
         sound = str_to_title(sound)) %>%
  mutate(BinaryTime = case_when(
    DayTime %in% 0:11 ~ "AM",
    DayTime %in% 12:23 ~ "PM"
    )) %>%
  add_column(DaysFished = 1)%>%
  replace_na(list(BinaryTime="Unknown"))%>%
  distinct(sound, date, MONTH_DISPLAY, Year, DAY_DISPLAY, DOY, BinaryTime, DaysFished)

StatWeekLU <- read.csv("./Data/StatWeekLU.csv")
StatWeekLU$StatWeekLU <- as.factor(StatWeekLU$StatWeekLU)

#make sure dates are in the correct format
#have to be in yyyy/mm/dd for formatting with lubridate to work
StatWeekLU$DateStart <- lubridate::ymd(StatWeekLU$DateStart)
StatWeekLU$DateEnd <- lubridate::ymd(StatWeekLU$DateEnd)

TemporalPlot1 <- fuzzy_left_join(TemporalPlot, all_of(StatWeekLU), 
                by = c("date"="DateStart", "date"="DateEnd"),
                match_fun = list(`>=`, `<=`)) %>% 
  select(sound, Year, Month, DAY_DISPLAY, StatWeekLU, BinaryTime, DaysFished)

statweekspermonth <- StatWeekLU %>%
  group_by(Month) %>%
  summarize(totalstatweeks=n_distinct(StatWeekLU),
            .groups = "drop")


#table for how many blank rows that need to be added 
#this does not always work because a stat week can have days from two months included, so joining by month can be misleading.
#Quatsino Feb 28th 2021 actually fall in stat week 31 ("March" statweeks)
#recoded to use month that is based off statistical weeks rather than by actual month of survey - so the Quatsino survey on Jan 28th now shows as February survey - this will make the plotting easier by stat week
TemporalPlot2 <- TemporalPlot1 %>%
  group_by(sound, Month) %>%
  summarize(n = n_distinct(StatWeekLU),
            .groups = "drop") %>%
left_join(., statweekspermonth, by = c("Month" = "Month")) %>%
   group_by(sound, Month) %>%
summarize(missingweeks = totalstatweeks - n,
          .groups = "drop")

#need to automate this still, need to work on
TemporalPlot2.1 <- uncount(TemporalPlot2, missingweeks) %>% #create the dataframe needed to fill blank rows
add_column(StatWeek= c("22", "23","34", "122", "123", "124", "125", "21", "22", "11", "12", "13", "15", "32", "33", "34", "111", "112", "113", "21", "22", "11", "12", "13", "15", "11", "12", "13", "14", "32", "33", "34"))%>%
  add_column(Year=c(rep(2021, 3), rep(2020,4), rep(2021, 9), rep(2020, 3), rep(2021, 13)))


 TemporalPlot3 <- TemporalPlot1 %>%
   add_row(sound=TemporalPlot2.1$sound, Year=TemporalPlot2.1$Year, Month=TemporalPlot2.1$Month, DAY_DISPLAY=NA, StatWeekLU=TemporalPlot2.1$StatWeek, DaysFished=0) 
 #this now has the blank rows for plotting
 
 TemporalPlot4 <- TemporalPlot3 %>%
  group_by(sound, Year, Month,DAY_DISPLAY, StatWeekLU,BinaryTime) 
 TemporalPlot4$StatWeekLU<-as.factor(TemporalPlot4$StatWeekLU)


 #Figures of the number of fishing days across sounds/year across statistical weeks
P1 <- ggplot(subset(TemporalPlot4, Year==2020), aes(x=StatWeekLU, y=DaysFished, fill=sound))+
geom_bar(stat="identity") +
  xlab("Statistical Week") +
  ylab("Days Fished") +
  ggtitle("2020 Fishing Days") +
  scale_fill_manual(values = "lightblue3")


P2 <- ggplot(subset(TemporalPlot4, Year==2021), aes(x=StatWeekLU, y=DaysFished, fill=sound))+
geom_bar(stat = "identity") +
  xlab("Statistical Week") +
   scale_y_continuous(breaks = c(0,2, 4, 6, 8, 10))+
    ylab("Days Fished") +
  ggtitle("2021 Fishing Days") +
  scale_fill_manual(values = c("Barkley"="lightblue1", "Clayoquot" = "lightblue3", "Nootka" = "mediumaquamarine", "Quatsino" = "lightcyan4"))

 
#coloured by AM vs PM fishing days
#I needed to remove NA values but this addmitted all of these rows, no comprehensive x-axis is shown now for statistical week 
P3<-ggplot(subset(TemporalPlot4, Year==2020 & !is.na(BinaryTime)), aes(x=StatWeekLU, y=DaysFished, fill=BinaryTime))+
geom_bar(stat="identity")+
  xlab("Statistical Week")+
    ylab("Days Fished")+
  ggtitle("2020 Fishing Days")+
   scale_fill_manual(values = c("AM"="gray48", "PM"="gray85", "Unknown"="gray24"))


P4<-ggplot(subset(TemporalPlot4, Year==2021 & !is.na(BinaryTime)), aes(x=StatWeekLU, y=DaysFished, fill=na.omit(BinaryTime)))+
geom_bar(stat="identity")+
  xlab("Statistical Week")+
  scale_y_continuous(breaks = c(0,2, 4, 6, 8, 10))+
    ylab("Days Fished")+
  ggtitle("2021 Fishing Days")+
  scale_fill_manual(values = c("AM"="gray48", "PM"="gray85", "Unknown"="gray24"))


plot_grid(P1 + theme(legend.position = "none")
          , P2 + theme(legend.title = element_blank())
          , P3 + theme(legend.position = "none" )
          , P4 + theme(legend.title = element_blank())) 
         


  
```

  
## Maps

There are two maps per sound showing juvenile chinook and coho salmon catch. The circles are proportional to the amount of catch i.e. the more fish caught, the bigger the circles.  The black crosses represents fishing events with no catch.  

```{r maps, message = FALSE}

mapdf <- site %>%
  full_join(., sets, by = c("site_id", "timezone")) %>%
  full_join(., fish, by = "fishingset_id")

# create function to map each sound sampled
mapSoundfn <- function(soundName, mapdf, resolution) {
  
df <- mapdf %>%
  filter(sound == toupper(soundName)) %>%
  filter(!(is.na(start_latitude))) %>%
  filter(!(is.na(start_longitude))) %>%
  group_by(fishingset_id, start_latitude, start_longitude, 
           end_latitude, end_longitude, hook_depth_min, hook_depth_max,
           hooks_used, species) %>%
  summarize(hooks = sum(hooks_used, na.rm = TRUE),
            catch = n(),
            catchByhook = catch/hooks,
            .groups = 'drop')

# use standard min and max lat and longs for limits to basemap for each sound
# add Kyuquot and Nootka when fishing starts
if (soundName == "CLAYOQUOT") {
  minLat <- 49.1
  maxLat <- 49.5
  minLon <- -126.3
  maxLon <- -125.7
}

if (soundName == "QUATSINO") {
  minLat <- 50.45
  maxLat <- 50.65
  minLon <- -127.8
  maxLon <- -127.3
}

if (soundName == "BARKLEY") {
  minLat <- 48.75
  maxLat <- 49.1
  minLon <- -125.5
  maxLon <- -124.9
}

if (soundName == "NOOTKA") {
  minLat <- 49.5
  maxLat <- 49.85
  minLon <- -126.8
  maxLon <- -126.0
}

# df for each species
df_ck <- df %>% filter(species == "CN" | is.na(species))
df_co <- df %>% filter(species == "CO" | is.na(species))


##  Mapping data from bcmaps
bcn <- bc_neighbours()
bcn <- bcn %>% st_transform(4326)
bcn1 <- bcn %>%
  filter(name != "British Columbia") %>%  
  filter(name != "Pacific Ocean")

if (resolution == "high") {
  
bchigh <- bc_bound_hres()
bchigh <- bchigh %>% st_transform(4326)

#use for high res map sucha s for final
basemap <- ggplot() +
 geom_sf(data = bchigh, fill = "lightyellow1") +
 geom_sf(data = bcn1) +
 xlim(minLon, maxLon) +
 ylim(minLat, maxLat) +
 xlab("Longitude") + ylab("Latitude") +
 theme_bw() #+
# theme(panel.background = element_rect(fill = "lightcyan2"))
  } 

if (resolution == "low") {
  
bclow <- bc_bound()
bclow <- bclow %>% st_transform(4326)

#low res version of bcmaps - good for quicker drafts
basemap <- ggplot() +
  geom_sf(data = bclow, fill = "lightyellow1") +
  geom_sf(data = bcn1) +
  xlim(minLon, maxLon) +
  ylim(minLat, maxLat) +
  xlab("Longitude") + ylab("Latitude") +
  theme_bw() 

}

map_ck <- basemap +
    geom_point(data = filter(df_ck, is.na(species)),
             aes(start_longitude, start_latitude),
             shape = 3) +
      geom_point(data = filter(df_ck, !(is.na(species))),
             aes(start_longitude, start_latitude, size = catchByhook),
             color = "darkred", alpha = 0.5) +
  theme(axis.text = element_blank(),
        axis.title = element_blank()
        #,
        #legend.position = "bottom"
        ) +
  labs(size = "Salmon \nper Hook",
       subtitle = "Chinook") +
  scale_size_continuous(breaks = c(0.15, 0.20, 0.25, 0.30))

map_co <- basemap +
    geom_point(data = filter(df_co, is.na(species)),
             aes(start_longitude, start_latitude),
             shape = 3) +
      geom_point(data = filter(df_co, !(is.na(species))),
             aes(start_longitude, start_latitude, size = catchByhook),
             color = "darkred", alpha = 0.5) +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "none") + # when there are more coho confirm that scales are same
  labs(size = "Salmon \nper Hook",
       subtitle = "Coho") +
  scale_size_continuous(breaks = c(0.15, 0.20,0.25, 0.30))

map_ck + map_co

}

## future addition to run through all sounds in dataset
#sound_vec <- unique(site$sound)
#allMaps <- sound_vec %>%
#  map(mapSoundfn, mapdf = mapdf, resolution = "low")

# create Figure folder if it doesn't exist yet
if (!dir.exists("Figures")) dir.create("Figures")

# run these once with data then comment out to knit since long
# create maps individually and save at lower resolution
# clayoquotMap <- mapSoundfn("CLAYOQUOT", mapdf, "high")
# ggsave("clayoquotMap.png", clayoquotMap, path = "Figures", height = 4, units = "in", dpi = 300)
# quatsinoMap <- mapSoundfn("QUATSINO", mapdf, "high")
# ggsave("quatsinoMap.png", quatsinoMap, path = "Figures", height = 3, units = "in", dpi = 300)
# barkleyMap <- mapSoundfn("BARKLEY", mapdf, "high")
# ggsave("barkleyMap.png", barkleyMap, path = "Figures", height = 3.5, units = "in", dpi = 300)
# nootkaMap <- mapSoundfn("NOOTKA", mapdf, "high")
# ggsave("nootkaMap.png", nootkaMap, path = "Figures", height = 3, units = "in", dpi = 300)

```

### Quatsino Sound  
```{r quatsinoMap, fig.align = 'center', fig.cap = "Quatsino Sound Catch and Fishing Effort"}

knitr::include_graphics(here::here("Figures", "quatsinoMap.png"))

```

### Nootka Sound  
```{r nootkaMap, fig.align = 'center', fig.cap = "Nootka Sound Catch and Fishing Effort"}

knitr::include_graphics(here::here("Figures", "nootkaMap.png"))

```

### Clayoquot Sound  
```{r clayoquotMap, fig.align = 'center', fig.cap = "Clayoquot Sound Catch and Fishing Effort"}

knitr::include_graphics(here::here("Figures", "clayoquotMap.png"))

```

### Barkley Sound
```{r barkleyMap, fig.align = 'center', fig.cap = "Barkley Sound Catch and Fishing Effort"}

knitr::include_graphics(here::here("Figures", "barkleyMap.png"))

```
 
## Salmon Lengths and Weights

The Chinook Salmon lengths and weights are graphed below.

```{r forkfn}

lengthFreq <- mapdf %>%
  select(sound, fish_id, species, fork_length_mm, fresh_weight_g) %>%
  filter(!(is.na(fish_id))) 

### create function to repeat graphs on different species
graphSpecies <- function(lengthFreq, thisspecies, thissound) {
  
  # select this sound and species only
thisdf <- lengthFreq %>%
  filter(sound == toupper(thissound)) %>%
  # select species
  filter(species == thisspecies)

# remove NA weights and lengths
df.LW <- thisdf %>%
  filter(!is.na(fork_length_mm)) %>%
  filter(!is.na(fresh_weight_g))

# graph length frequency
dfbar <- ggplot(df.LW) +
  geom_histogram(aes(fork_length_mm), binwidth = 5) +
  labs(x = "Length (mm)",
       y = "Count") +
  theme_bw() 

# graph log length by weight
dffit <- ggplot(df.LW) +
  geom_point(aes(fork_length_mm, fresh_weight_g)) +
  labs(x = "Length (mm)",
       y = "Weight (g)") +
    theme_bw() 

# put both graphs together
dfbar / dffit + plot_annotation(title = thissound)

}

```


```{r lwQuatsinoCK, fig.height = 3, fig.cap="Lengths and Weights of Quatsino Juvenile Chinook Salmon."}

# create graphs
QuatsinoCK <- graphSpecies(lengthFreq, "CN", "Quatsino")
QuatsinoCK

```


```{r lwNootkaCK, fig.height = 3, fig.cap="Lengths and Weights of Nootka Juvenile Chinook Salmon."}

# create graphs
NootkaCK <- graphSpecies(lengthFreq, "CN", "Nootka")
NootkaCK

```


```{r lwClayoquotCK, fig.height = 3, fig.cap="Lengths and Weights of Clayoquot Chinook Salmon."}

# create graphs
ClayoquotCK <- graphSpecies(lengthFreq, "CN", "Clayoquot")
ClayoquotCK

```


```{r lwBarkleyCK, fig.height = 3, fig.cap="Lengths and Weights of Barkley Chinook Salmon."}

# create graphs
BarkleyCK <- graphSpecies(lengthFreq, "CN", "Barkley")
BarkleyCK

```


```{r lwClayoquotCo, fig.height = 3, fig.cap="Lengths and Weights of Clayoquot Coho Salmon."}

# # create graphs
# ClayoquotCO <- graphSpecies(lengthFreqClayoquot, "CO")
# ClayoquotCO

```

## Stomach Content Analysis

Preliminary informaiton on prey items identified in sample stomachs are shown below, remaining samples will be processed and updated here.
```{r Stomach Content."}

#Figure of Stomach content across sounds and fishing trips 
stomach.1 <- stomach %>%
  left_join(., stomachLU, by = c("prey_item" = "prey_code")) %>%
  select(fish_id, prey_item, prey_no, prey_description) %>%
  left_join(., fish, by = "fish_id") %>%
  select(fish_id, fishingset_id, species, prey_item, prey_no, prey_description) %>%
  left_join(., sets, by = "fishingset_id") %>%
  select(fish_id, site_id, fishingset_id, species,prey_item, prey_no, prey_description) %>%
  left_join(., site, by = "site_id") %>%
  select(sound, date, fish_id, site_id, fishingset_id, species,prey_item, prey_no, prey_description)%>%
  mutate(Month = month(date, label = TRUE, abbr = TRUE),
         sound = str_to_title(sound)) %>%
  mutate(date = lubridate::ymd(date)) %>% #formatted so R recognizes this as a date
  mutate(CountPrey = 1) # making a column to plot counts, this will include prey that appear in multiple fish
#n_distinct(stomach.1$fish_id) #19 fish represented here

#could organize this by stat week and show prey items across weeks - summarizing by stat week is not very intuitive to me
#since some stat weeks include days from two months


```


```{r stomachClay, fig.height = 3, fig.cap="Prey items within Clayoquot juvenile chinook salmon."}

# create graphs
#prey items from fish samples in Clayoquot across sampling months
#note that for showing this into the future I would rather fill by sound/species (interaction) and facet wrap or grid by month
stomachClayplot <- ggplot(stomach.1, aes(x = prey_description, y = CountPrey, fill = Month)) +
  geom_bar(stat = "identity") +
  xlab("Prey item") +
  ylab("Number of fish") +
  ggtitle("Clayoquot Sound Chinook Stomach Contents (n=19)") +
  scale_fill_manual(values = c("Nov" = "gray48", "Dec" = "gray85"))

stomachClayplot

```

## Other Data
The `r randomSamples + clinicalSamples` samples transported to the Pacific Biological Station will be processed for infectious agents, stressors and diseases using FitChips; stomachs contents will be identified and quantified; genetic stock identification estimated using SNPs (single nucleotide polymorphisms); and energy density will be measured. 