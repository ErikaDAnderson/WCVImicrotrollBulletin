---
title: "WCVI Microtrolling Data Update"
output:
  pdf_document:
    toc: true
    toc_depth: 2
header-includes:
 \usepackage{float}
 \floatplacement{figure}{H}
 \floatplacement{table}{H}
 \usepackage{fancyhdr}
 \pagestyle{fancy}
 \fancyfoot[RO,RE]{Produced on `r format(Sys.Date(), "%b. %d, %Y")`}
---

## Purpose
The purpose of this data bulletin is to share preliminary data in season from mcirotrolling fishing events targetting juvenile Chinook and Coho Salmon in WCVI Sounds including Barkley, Claqyoquot, Nootka, and Quatsino. For more information on this project, please contact Jessy Bokvist at Jessy.Bokvist@dfo-mpo.gc.ca. This report was produced on `r format(Sys.Date(), "%b. %d, %Y")`.

```{r setup, include=FALSE}

library(tidyverse) # basic data manipulation
library(readxl) #read excel files easily
library(lubridate) # date times
library(kableExtra) # pretty tables
library(bcmaps) # bc basemaps
library(patchwork) # group plots together
library(ggpubr) # arrange plots another way
library(car) # stats
library(ggplot2) #temporal spread of fishing trips figure

# by default, do not show R code
knitr::opts_chunk$set(echo = FALSE)

```

```{r loadData}

# load data from all excel files in Data folder
site_orig <- list.files(path = "C:/Users/BOKVISTJ/Documents/Five Nations Reconciliation Budget/5N03 Juvenile Salmon/Juvenile CN Micro-trolling/WCVImicrotrollBulletin/",
                        pattern = "*.xlsx", 
                        full.names = T) %>% 
  map_df(~read_excel(., sheet = "01 SITE")) 

sets_orig <- list.files(path = "C:/Users/BOKVISTJ/Documents/Five Nations Reconciliation Budget/5N03 Juvenile Salmon/Juvenile CN Micro-trolling/WCVImicrotrollBulletin/",
                        pattern = "*.xlsx", 
                        full.names = T) %>% 
  map_df(~read_excel(., sheet = "02 FISHING SETS")) 

ocean_orig <- list.files(path = "C:/Users/BOKVISTJ/Documents/Five Nations Reconciliation Budget/5N03 Juvenile Salmon/Juvenile CN Micro-trolling/WCVImicrotrollBulletin/",
                         pattern = "*.xlsx",
                         full.names = T) %>%
  map_df(~read_excel(., sheet = "03 OCEANOGRAPHIC DATA"))

fish_orig <- list.files(path = "C:/Users/BOKVISTJ/Documents/Five Nations Reconciliation Budget/5N03 Juvenile Salmon/Juvenile CN Micro-trolling/WCVImicrotrollBulletin/",
                        pattern = "*.xlsx", 
                        full.names = T) %>% 
  map_df(~read_excel(., sheet = "04 FISH"))

stomach_orig <- list.files(path = "C:/Users/BOKVISTJ/Documents/Five Nations Reconciliation Budget/5N03 Juvenile Salmon/Juvenile CN Micro-trolling/WCVImicrotrollBulletin/",
                           pattern = "*.xlsx",
                           full.names = T) %>%
  map_df(~read_excel(., sheet = "05 STOMACH CONTENTS"))

# tidy data
site <- site_orig %>%
    # remove extra rows generated from NAs
  filter(!is.na(date)) %>%
  # remove default date given by excel in background
  mutate(time = str_sub(time, -8, -1),
         datetime = ymd_hms(str_c(date, time, sep = " ")))

sets <- sets_orig %>%
  mutate(end_time = str_sub(end_time, -8, -1))

ocean <- ocean_orig %>%
  mutate(time = str_sub(time, -8, -1))

fish <- fish_orig

stomach <- stomach_orig

# variables for text
overallStartDate <- format(min(site$date, na.rm = TRUE), "%b. %d, %Y")
overallEndDate <- format(max(site$date, na.rm = TRUE), "%b. %d, %Y")
numDaysFished <- site %>% select(date, sound) %>% distinct() %>% nrow()
soundsSampled <- unique(site$sound) %>% str_to_title() %>% sort()
ckCaught <- fish %>% filter(toupper(species) == "CN") %>% nrow()
coCaught <- fish %>% filter(toupper(species) == "CO") %>% nrow()
randomSamples <- fish %>% filter(frozen_random_clinical == "random") %>% nrow()
clinicalSamples <- fish %>% filter(frozen_random_clinical == "clinical") %>% nrow()

```


## Data Collected

This section summarizes the data collected from `r overallStartDate` to `r overallEndDate`. There were `r numDaysFished` days fished in total within the following sounds: `r soundsSampled`. In total, there were `r ckCaught` chinook and `r coCaught` coho caught. In addition, there were `r randomSamples` random samples and `r clinicalSamples` clinical samples frozen for transport to the Pacific Biological Station.

```{r dataCollected}
#JB March 24 2021 added in number of days fished/sound/month

sumfish <- sets %>%
  full_join(., site, by = "site_id") %>%
  select(sound, site_id, fishingset_id, date) %>%
  full_join(., fish, by = "fishingset_id") %>%
  mutate(MONTH_DISPLAY = month(date, label = TRUE, abbr = TRUE),
         sound = str_to_title(sound)) %>%
  mutate(DAY_DISPLAY = day(date),
         sound = str_to_title(sound)) %>%
  group_by(MONTH_DISPLAY, sound) %>%
  summarize(DaysFished = n_distinct(DAY_DISPLAY),
            ckCatch = sum(species == "CN", na.rm = TRUE),
            coCatch = sum(species == "CO", na.rm = TRUE),
            numRandom = sum(frozen_random_clinical == "random", na.rm = TRUE),
            numClinical = sum(frozen_random_clinical == "clinical", na.rm = TRUE),
            .groups = "drop") %>%
  mutate(MONTH_ORDER = case_when(
    MONTH_DISPLAY == "Oct" ~ 1,
    MONTH_DISPLAY == "Nov" ~ 2,
    MONTH_DISPLAY == "Dec" ~ 3,
    MONTH_DISPLAY == "Jan" ~ 4,
    MONTH_DISPLAY == "Feb" ~ 5,
    MONTH_DISPLAY == "Mar" ~ 6,
  )) %>%
  arrange(MONTH_ORDER) %>%
  select(-MONTH_ORDER)

kableExtra::kable(sumfish,
                  col.names = c("Month", "Location", "Days Fished", "Chinook", "Coho", "Random", "Clinical"),
                  booktabs = TRUE,
                  caption = "Summary of Salmon Caught and Samples Collected") %>%
  kable_styling() %>%
  add_header_above(c(" " = 3, "Catch" = 2, "Samples" = 2))


#Temporal spread of fishing Events Figure broken down by stat week
#Jessy Working on
sumfishsets <- sets %>%
  full_join(., site, by = "site_id") %>%
  select(sound, site_id, fishingset_id, date) %>%
  full_join(., fish, by = "fishingset_id") %>%
  mutate(MONTH_DISPLAY = month(date, label = TRUE, abbr = TRUE),
         sound = str_to_title(sound)) %>%
  mutate(DAY_DISPLAY = day(date),
         sound = str_to_title(sound)) %>%
  group_by(MONTH_DISPLAY, sound) %>%
  select(MONTH_DISPLAY, sound, DAY_DISPLAY) %>%
  summarize(unique(DAY_DISPLAY),
            .groups = "drop") %>%
  mutate(MONTH_ORDER = case_when(
    MONTH_DISPLAY == "Oct" ~ 1,
    MONTH_DISPLAY == "Nov" ~ 2,
    MONTH_DISPLAY == "Dec" ~ 3,
    MONTH_DISPLAY == "Jan" ~ 4,
    MONTH_DISPLAY == "Feb" ~ 5,
    MONTH_DISPLAY == "Mar" ~ 6,
  )) %>%
  arrange(MONTH_ORDER) %>%
  select(-MONTH_ORDER)

View(sumfishsets)

statweek = function(dates, format="%d-%m-%Y", ...) {
  # convert to Date
  dates = as.Date(dates, format=format, ...)
  # get correction for the first week of the year (0 if 1-Jan not a Sunday)
  firstweek = 1 - as.numeric(format(as.Date(cut(dates, "year")), "%U"))
  output = as.numeric(format(dates, "%U")) + firstweek
  return(output)
}

#fishing days, fishing times - categorize as AM vs. PM (stacked bar chart), want x-axis as month and each month 4 possible binned weeks
TemporalPlot <- sets %>%
  full_join(., site, by = "site_id") %>%
  select(sound, site_id, fishingset_id, date, start_time) %>%
  full_join(., fish, by = "fishingset_id") %>%
  mutate(MONTH_DISPLAY = month(date, label = TRUE, abbr = TRUE),
         sound = str_to_title(sound)) %>%
  mutate(DAY_DISPLAY = day(date),
         sound = str_to_title(sound)) %>%
  mutate(DOY = lubridate::yday(date),
         sound = str_to_title(sound)) %>%
  mutate(StatWeek = statweek(date),
         sound = str_to_title(sound)) %>%
mutate(DayTime = lubridate::hour(start_time),
         sound = str_to_title(sound)) %>%
  mutate(BinaryTime = case_when(
    DayTime %in% 0:11 ~ "AM",
    DayTime %in% 12:23 ~ "PM"
    )) %>%
  replace_na(list(BinaryTime="Unknown"))%>%
  distinct(sound, date, MONTH_DISPLAY, DAY_DISPLAY, StatWeek, DOY, BinaryTime)
View(TemporalPlot)

install.packages("fuzzyjoin")
library(fuzzyjoin)
TemporalPlot %>%
fuzzy_left_join(TemporalPlot, StatWeekLU, 
                by=c("date"="DateStart", "date"="DateEnd"),
                match_fun=list(`>=`, `<=`)) %>% 
  select(DOY, StatWeekLU)

Result <- cbind(TemporalPlot, StatWeek=sapply(1:nrow(TemporalPlot),function(x) StatWeekLU$beginning[data2$beginning[x]<data1$date & data2$ending[x]>data1$date]),
            "ending"=sapply(1:nrow(data2),function(x) data2$ending[data2$beginning[x]<data1$date & data2$ending[x]>data1$date]),
            "class"=sapply(1:nrow(data2),function(x) data2$class[data2$beginning[x]<data1$date & data2$ending[x]>data1$date]))
 

StatWeekLU <- read.csv("C:/Users/BOKVISTJ/Documents/Five Nations Reconciliation Budget/5N03 Juvenile Salmon/Juvenile CN Micro-trolling/WCVImicrotrollBulletin/StatWeekLU.2.csv")
View(StatWeekLU)

View(TemporalPlot)

#March 27th make a lookup table for the StatWeeks and import here, cross lookup

#this needs to be automated, add in blank rows based on number of rows avaialble for each statweek and time rep x for 4-unique(Statweek)
require(reprex)
library(reprex)

TemporalPlot2 <- TemporalPlot %>%
  #modify_if(unique(TemporalPlot$StatWeek <4)) %>%
 # add_row(sound="1", MONTH_DISPLAY="2", DAY_DISPLAY=4, StatWeek=6, BinaryTime="9")
  group_by(sound, MONTH_DISPLAY) %>%
summarize(reps = 4 - n_distinct(StatWeek)) 
View(TemporalPlot2)

install.packages("SwimmeR")
library(SwimmeR)
install.packages("sqldf")
library(sqldf)

TemporalPlot2.1 <- uncount(TemporalPlot2, reps) %>% #create the dataframe needed to fill blank rows
mutate(IDforStatWeek = row_number())
View(TemporalPlot2.1)

 TemporalPlot3 <- TemporalPlot %>%
 add_row(sound=TemporalPlot2.1$sound, MONTH_DISPLAY=TemporalPlot2.1$MONTH_DISPLAY, DAY_DISPLAY=NA, StatWeek=TemporalPlot2.1$IDforStatWeek, BinaryTime=NA) 
 #this now has the blank rows for plotting
 
 
 
 TemporalPlot4 <- TemporalPlot3 %>%
     group_by(sound, MONTH_DISPLAY, BinaryTime, StatWeek) %>%
   summarize(fishingdays=length(StatWeek))


ggplot(TemporalPlot4, aes(x=MONTH_DISPLAY, y=fishingdays, fill=interaction(sound,BinaryTime)))+
geom_bar(stat="identity")

  fill=interaction(TrialType,Group)
  View(TemporalPlot2)
  
View(TemporalPlot2.1)
View(TemporalPlot2)
  complete(StatWeek, nesting(sound)) %>%
           arrange(sound)
         
         
length(TemporalPlot)
View(TemporalPlot2)

 plot <- data.frame(
   sound = rep(c("Barkley", "Clayoquot", "Nootka", "Quatsino"),4),
   Weeks = rep(1:4, 64))#,
   Time = rep(c("AM","PM"), 1))

View(ocean)

View(TemporalPlot2)

#data %>%
  complete(day, nesting(name, id)) %>%
  arrange(name)
```

  
## Maps

There are two maps per sound showing juvenile chinook and coho salmon catch. The circles are proportional to the amount of catch i.e. the more fish caught, the bigger the circles.  The black crosses represents fishing events with no catch.  

```{r maps, message = FALSE}

mapdf <- site %>%
  full_join(., sets, by = c("site_id", "timezone")) %>%
  full_join(., fish, by = "fishingset_id")

# create function to map each sound sampled
mapSoundfn <- function(soundName, mapdf, resolution) {
  
df <- mapdf %>%
  filter(sound == toupper(soundName)) %>%
  filter(!(is.na(start_latitude))) %>%
  filter(!(is.na(start_longitude))) %>%
  group_by(fishingset_id, start_latitude, start_longitude, 
           end_latitude, end_longitude, hook_depth_min, hook_depth_max,
           hooks_used, species) %>%
  summarize(hooks = sum(hooks_used, na.rm = TRUE),
            catch = n(),
            catchByhook = catch/hooks,
            .groups = 'drop')

# use standard min and max lat and longs for limits to basemap for each sound
# add Kyuquot and Nootka when fishing starts
if (soundName == "CLAYOQUOT") {
  minLat <- 49.1
  maxLat <- 49.5
  minLon <- -126.3
  maxLon <- -125.7
}

if (soundName == "QUATSINO") {
  minLat <- 50.45
  maxLat <- 50.65
  minLon <- -127.8
  maxLon <- -127.3
}

if (soundName == "BARKLEY") {
  minLat <- 48.75
  maxLat <- 49.1
  minLon <- -125.5
  maxLon <- -124.9
}

if (soundName == "NOOTKA") {
  minLat <- 49.5
  maxLat <- 49.85
  minLon <- -126.8
  maxLon <- -126.0
}

# df for each species
df_ck <- df %>% filter(species == "CN" | is.na(species))
df_co <- df %>% filter(species == "CO" | is.na(species))


##  Mapping data from bcmaps
bcn <- bc_neighbours()
bcn <- bcn %>% st_transform(4326)
bcn1 <- bcn %>%
  filter(name != "British Columbia") %>%  
  filter(name != "Pacific Ocean")

if (resolution == "high") {
  
bchigh <- bc_bound_hres()
bchigh <- bchigh %>% st_transform(4326)

#use for high res map sucha s for final
basemap <- ggplot() +
 geom_sf(data = bchigh, fill = "lightyellow1") +
 geom_sf(data = bcn1) +
 xlim(minLon, maxLon) +
 ylim(minLat, maxLat) +
 xlab("Longitude") + ylab("Latitude") +
 theme_bw() #+
# theme(panel.background = element_rect(fill = "lightcyan2"))
  } 

if (resolution == "low") {
  
bclow <- bc_bound()
bclow <- bclow %>% st_transform(4326)

#low res version of bcmaps - good for quicker drafts
basemap <- ggplot() +
  geom_sf(data = bclow, fill = "lightyellow1") +
  geom_sf(data = bcn1) +
  xlim(minLon, maxLon) +
  ylim(minLat, maxLat) +
  xlab("Longitude") + ylab("Latitude") +
  theme_bw() 

}

map_ck <- basemap +
    geom_point(data = filter(df_ck, is.na(species)),
             aes(start_longitude, start_latitude),
             shape = 3) +
      geom_point(data = filter(df_ck, !(is.na(species))),
             aes(start_longitude, start_latitude, size = catchByhook),
             color = "darkred", alpha = 0.5) +
  theme(axis.text = element_blank(),
        axis.title = element_blank()
        #,
        #legend.position = "bottom"
        ) +
  labs(size = "Salmon \nper Hook",
       subtitle = "Chinook") +
  scale_size_continuous(breaks = c(0.15, 0.20, 0.25, 0.30))

map_co <- basemap +
    geom_point(data = filter(df_co, is.na(species)),
             aes(start_longitude, start_latitude),
             shape = 3) +
      geom_point(data = filter(df_co, !(is.na(species))),
             aes(start_longitude, start_latitude, size = catchByhook),
             color = "darkred", alpha = 0.5) +
  theme(axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "none") + # when there are more coho confirm that scales are same
  labs(size = "Salmon \nper Hook",
       subtitle = "Coho") +
  scale_size_continuous(breaks = c(0.15, 0.20,0.25, 0.30))

map_ck + map_co

}

## future addition to run through all sounds in dataset
#sound_vec <- unique(site$sound)
#allMaps <- sound_vec %>%
#  map(mapSoundfn, mapdf = mapdf, resolution = "low")

# run these once with data then comment out to knit since long
# create maps individually and save at lower resolution
clayoquotMap <- mapSoundfn("CLAYOQUOT", mapdf, "high")
ggsave("clayoquotMap.png", clayoquotMap, path = "Figures", height = 4, units = "in", dpi = 300)
quatsinoMap <- mapSoundfn("QUATSINO", mapdf, "high")
ggsave("quatsinoMap.png", quatsinoMap, path = "Figures", height = 3, units = "in", dpi = 300)
barkleyMap <- mapSoundfn("BARKLEY", mapdf, "high")
ggsave("barkleyMap.png", barkleyMap, path = "Figures", height = 3.5, units = "in", dpi = 300)
nootkaMap <- mapSoundfn("NOOTKA", mapdf, "high")
ggsave("nootkaMap.png", nootkaMap, path = "Figures", height = 3, units = "in", dpi = 300)

```

### Quatsino Sound  
```{r quatsinoMap, fig.align = 'center', fig.cap = "Quatsino Sound Catch and Fishing Effort"}

knitr::include_graphics(here::here("Figures", "quatsinoMap.png"))

```

### Nootka Sound  
```{r nootkaMap, fig.align = 'center', fig.cap = "Nootka Sound Catch and Fishing Effort"}

knitr::include_graphics(here::here("Figures", "nootkaMap.png"))

```

### Clayoquot Sound  
```{r clayoquotMap, fig.align = 'center', fig.cap = "Clayoquot Sound Catch and Fishing Effort"}

knitr::include_graphics(here::here("Figures", "clayoquotMap.png"))

```

### Barkley Sound
```{r barkleyMap, fig.align = 'center', fig.cap = "Barkley Sound Catch and Fishing Effort"}

knitr::include_graphics(here::here("Figures", "barkleyMap.png"))

```
 
## Salmon Lengths and Weights

The chinook salmon lengths and weights are graphed below.

```{r forkfn}

lengthFreq <- mapdf %>%
  select(sound, fish_id, species, fork_length_mm, fresh_weight_g) %>%
  filter(!(is.na(fish_id))) 

### create function to repeat graphs on different species
graphSpecies <- function(lengthFreq, thisspecies, thissound) {
  
  # select this sound and species only
thisdf <- lengthFreq %>%
  filter(sound == toupper(thissound)) %>%
  # select species
  filter(species == thisspecies)

# remove NA weights and lengths
df.LW <- thisdf %>%
  filter(!is.na(fork_length_mm)) %>%
  filter(!is.na(fresh_weight_g))

# graph length frequency
dfbar <- ggplot(df.LW) +
  geom_histogram(aes(fork_length_mm), binwidth = 5) +
  labs(x = "Length (mm)",
       y = "Count") +
  theme_bw() 

# graph log length by weight
dffit <- ggplot(df.LW) +
  geom_point(aes(fork_length_mm, fresh_weight_g)) +
  labs(x = "Length (mm)",
       y = "Weight (g)") +
    theme_bw() 

# put both graphs together
dfbar / dffit + plot_annotation(title = thissound)

}

```


```{r lwQuatsinoCK, fig.height = 3, fig.cap="Lengths and Weights of Quatsino Juvenile Chinook Salmon."}

# create graphs
QuatsinoCK <- graphSpecies(lengthFreq, "CN", "Quatsino")
QuatsinoCK

```


```{r lwNootkaCK, fig.height = 3, fig.cap="Lengths and Weights of Nootka Juvenile Chinook Salmon."}

# create graphs
NootkaCK <- graphSpecies(lengthFreq, "CN", "Nootka")
NootkaCK

```


```{r lwClayoquotCK, fig.height = 3, fig.cap="Lengths and Weights of Clayoquot Chinook Salmon."}

# create graphs
ClayoquotCK <- graphSpecies(lengthFreq, "CN", "Clayoquot")
ClayoquotCK

```


```{r lwBarkleyCK, fig.height = 3, fig.cap="Lengths and Weights of Barkley Chinook Salmon."}

# create graphs
BarkleyCK <- graphSpecies(lengthFreq, "CN", "Barkley")
BarkleyCK

```


```{r lwClayoquotCo, fig.height = 3, fig.cap="Lengths and Weights of Clayoquot Coho Salmon."}

# # create graphs
# ClayoquotCO <- graphSpecies(lengthFreqClayoquot, "CO")
# ClayoquotCO

```

## Other Data
The `r randomSamples + clinicalSamples` samples transported to the Pacific Biological Station will be processed for infectious agents, stressors and diseases using FitChips; stomachs contents will be identified and quantified; genetic stock identification estimated using SNPs (single nucleotide polymorphisms); and energy density will be measured. 


